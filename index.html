<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVANGELION Sim -Full Spec-</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@800&display=swap');
        body { background: #050505; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { width: 100%; height: 50px; background: #000; border-bottom: 2px solid #d00000; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; }
        .menu-btn { background: #d00000; color: white; border: 1px solid #ff4444; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem; border-radius: 3px; margin-right: 5px; }
        .logo-main { flex-grow: 1; text-align: center; font-family: 'Shippori Mincho B1', serif; font-size: 1rem; color: #d00000; text-shadow: 0 0 5px #d00000; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; width: 100%; box-sizing: border-box; }
        .machine { width: 100%; max-width: 400px; background: #111; border: 2px solid #d00000; border-radius: 10px; padding: 15px; box-sizing: border-box; position: relative; }
        
        .screen { background: #000; height: 130px; border-radius: 5px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 10px; position: relative; overflow: hidden; }
        .digit { font-size: 3rem; font-weight: 900; font-family: 'Shippori Mincho B1', serif; width: 50px; text-align: center; }
        .gold { color: #ffeb3b; text-shadow: 0 0 10px #ffeb3b; } .odd { color: #ff4444; } .even { color: #4444ff; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 4px; width: 100%; }
        .stat-item { background: #000; border: 1px solid #333; padding: 4px 1px; text-align: center; border-radius: 3px; }
        .stat-label { font-size: 0.5rem; color: #888; display: block; }
        .stat-val { font-size: 0.8rem; font-weight: bold; color: #d00000; font-family: monospace; }

        .control-layout { display: flex; gap: 5px; width: 100%; margin-top: 8px; }
        .side-mini-btns { display: flex; flex-direction: column; gap: 4px; width: 50px; }
        .mini-btn { flex: 1; font-size: 0.7rem; font-weight: bold; border: 1px solid #444; background: #222; color: #888; cursor: pointer; border-radius: 3px; }
        .mini-btn.active { background: #d00000; color: white; border-color: #ff4444; }
        .btn-auto { flex: 1; background: #d00000; color: white; border: 2px solid #ff4444; padding: 12px; font-size: 0.9rem; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .btn-stop { background: #444 !important; border-color: #666 !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .chart-container { background: #fff; border-radius: 10px; padding: 10px; margin-bottom: 10px; height: 230px; }
        .log { width: 100%; max-width: 400px; height: 100px; background: #000; margin-top: 10px; padding: 10px; border-radius: 5px; font-size: 0.7rem; color: #ff4444; overflow-y: auto; border: 1px solid #333; font-family: monospace; }
    </style>
</head>
<body>

<header>
    <button class="menu-btn" onclick="openMenu('machine')">機種</button>
    <button class="menu-btn" onclick="openMenu('data')" style="background:#0066cc;">データ</button>
    <div class="logo-main" id="machine-title">エヴァ15 未来への咆哮</div>
</header>

<div class="modal" id="dataModal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <h2 style="margin:0; font-size: 1.2rem;">分析データ</h2>
        <button onclick="closeMenu('dataModal')" style="background:#d00000; color:white; border:none; padding:5px 15px;">閉じる</button>
    </div>
    <div class="chart-container"><canvas id="slumpChart"></canvas></div>
    <div class="chart-container"><canvas id="distChart"></canvas></div>
</div>

<div class="modal" id="machineModal">
    <div style="background:#111; border:2px solid #d00000; padding:20px; border-radius:10px; width:80%; margin:auto;">
        <h3 style="text-align:center; color:#d00000;">機種選択</h3>
        <div style="padding:15px; background:#222; margin-bottom:10px; cursor:pointer; text-align:center;" onclick="selectMachine('EVA15')">エヴァ15 (1/319)</div>
        <div style="padding:15px; background:#222; cursor:pointer; text-align:center;" onclick="selectMachine('GOD')">GOD Ver (1/8192)</div>
        <button style="width:100%; padding:10px; margin-top:10px;" onclick="closeMenu('machineModal')">閉じる</button>
    </div>
</div>

<div class="main-content">
    <div class="machine">
        <div class="screen">
            <div style="display:flex; justify-content:center; gap:10px;">
                <div id="d1" class="digit">1</div><div id="d2" class="digit">2</div><div id="d3" class="digit">3</div>
            </div>
            <div id="sub-display" style="position:absolute; bottom:5px; right:10px; color:#d00000; font-size:0.6rem; font-weight:bold;">READY</div>
        </div>

        <div class="stat-grid">
            <div class="stat-item"><span class="stat-label">大当り</span><span id="hits" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">連チャン</span><span id="rush-count" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">現在回転</span><span id="current-rot" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">収支(円)</span><span id="balance" class="stat-val">0</span></div>
        </div>
        <div class="stat-grid">
            <div class="stat-item"><span class="stat-label">最高連</span><span id="max-rush" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">初当り</span><span id="first-hits" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">RUSH突入</span><span id="rush-in" class="stat-val">0</span></div>
            <div class="stat-item"><span class="stat-label">最大ハマ</span><span id="max-hamari" class="stat-val">0</span></div>
        </div>
        
        <div class="control-layout">
            <div class="side-mini-btns">
                <button class="mini-btn" id="full-auto-toggle" onclick="toggleFullAuto()">全</button>
                <button class="mini-btn" id="gyakkyo-toggle" onclick="toggleGyakkyo()">逆</button>
            </div>
            <div class="main-btns">
                <button class="btn-auto" id="btn-slow" onclick="toggleAuto('slow')">低速オート</button>
                <button class="btn-auto" id="btn-fast" onclick="toggleAuto('fast')">高速オート</button>
            </div>
        </div>
    </div>
    <div class="log" id="log">> エヴァ15：起動完了<br></div>
</div>

<script>
    const MACHINES = {
        'EVA15': { normal: 319.7, st: 99.4, st_taps: 163, j_taps: 100 },
        'GOD': { normal: 8192, st: 99.4, st_taps: 100, j_taps: 50 }
    };
    let currentSpec = MACHINES['EVA15'];
    let hits=0, rushCount=0, currentCount=0, totalBall=0, firstHits=0, rushIn=0, maxRush=0, maxHamari=0;
    let mode='NORMAL', rRemaining=0, isAuto=false, autoSpeed='slow', isFullAuto=false, isGyakkyo=false, autoTimer=null;
    
    let balanceHistory = [0], distData = [0, 0, 0, 0, 0];

    function openMenu(type) { 
        if(type === 'data') { updateCharts(); document.getElementById('dataModal').style.display = 'flex'; }
        else document.getElementById('machineModal').style.display = 'flex';
    }
    function closeMenu(id) { document.getElementById(id).style.display = 'none'; }
    function selectMachine(key) { currentSpec = MACHINES[key]; resetData(); closeMenu('machineModal'); }

    function resetData() {
        hits=0; rushCount=0; currentCount=0; totalBall=0; firstHits=0; rushIn=0; maxRush=0; maxHamari=0;
        mode='NORMAL'; balanceHistory=[0]; distData=[0,0,0,0,0]; updateUI(); addLog("データをリセットしました");
    }

    function toggleFullAuto() { isFullAuto = !isFullAuto; document.getElementById('full-auto-toggle').classList.toggle('active', isFullAuto); }
    function toggleGyakkyo() { isGyakkyo = !isGyakkyo; document.getElementById('gyakkyo-toggle').classList.toggle('active', isGyakkyo); }

    function toggleAuto(speed) {
        if (isAuto && autoSpeed === speed) { isAuto=false; clearTimeout(autoTimer); } 
        else { isAuto=true; autoSpeed=speed; startProcess(); }
        updateButtons();
    }
    function updateButtons() {
        document.querySelectorAll('.btn-auto').forEach(b => b.classList.remove('btn-stop'));
        if(isAuto) document.getElementById(autoSpeed==='slow'?'btn-slow':'btn-fast').classList.add('btn-stop');
    }

    async function startProcess() {
        if (!isAuto) return;
        if(mode==='NORMAL') totalBall -= 12.5; // 通常時のみ消費
        currentCount++;
        
        if(currentCount % 20 === 0) { 
            balanceHistory.push(Math.floor(totalBall*4)); 
            if(balanceHistory.length > 100) balanceHistory.shift(); 
        }

        // 確率抽選（ST/時短中は共通確率）
        let prob = (mode==='NORMAL' ? currentSpec.normal : currentSpec.st);
        let isHit = Math.random() < (1 / prob);

        if (isHit) {
            hits++;
            if(currentCount > maxHamari) maxHamari = currentCount;

            if(mode==='NORMAL') {
                firstHits++;
                // 初当分布カウント
                if(currentCount <= 100) distData[0]++; else if(currentCount <= 300) distData[1]++;
                else if(currentCount <= 500) distData[2]++; else if(currentCount <= 1000) distData[3]++; else distData[4]++;

                let isSt = Math.random() < 0.59; // エヴァ15のST突入率
                if(isSt) {
                    mode='ST'; rRemaining=currentSpec.st_taps; rushCount=1; rushIn++;
                    addLog(`初当り(ST)：${currentCount}回転`);
                } else {
                    mode='JITITAN'; rRemaining=currentSpec.j_taps; rushCount=0;
                    addLog(`初当り(時短)：${currentCount}回転`);
                }
            } else {
                // RUSH中または時短中の当り
                if(mode==='JITITAN') rushIn++; // 時短引き戻しも突入にカウント
                mode='ST'; rRemaining=currentSpec.st_taps; rushCount++;
                if(rushCount > maxRush) maxRush=rushCount;
                addLog(`引き戻し：${rushCount}連目`);
                totalBall += 1400; // 10R分
            }
            if(mode==='ST') totalBall += 1400; else totalBall += 400; // 初当りの払い出し
            currentCount=0;
        } else if(mode !== 'NORMAL') {
            rRemaining--;
            if(rRemaining <= 0) {
                addLog(`${mode}終了：${rushCount}連`);
                mode='NORMAL'; rushCount=0;
                if(!isFullAuto) isAuto=false; // フルオートでなければ終了時に停止
            }
        }
        
        updateUI();
        updateButtons();
        let delay = isFullAuto ? 2 : (autoSpeed==='fast' ? 50 : 800);
        autoTimer = setTimeout(startProcess, delay);
    }

    function updateUI() {
        document.getElementById('hits').innerText = hits;
        document.getElementById('rush-count').innerText = rushCount;
        document.getElementById('current-rot').innerText = currentCount;
        document.getElementById('max-rush').innerText = maxRush;
        document.getElementById('first-hits').innerText = firstHits;
        document.getElementById('rush-in').innerText = rushIn;
        document.getElementById('max-hamari').innerText = maxHamari;
        const b = Math.floor(totalBall*4);
        const balEl = document.getElementById('balance');
        balEl.innerText = b.toLocaleString();
        balEl.style.color = b>=0 ? "#4caf50" : "#ff4444";
        document.getElementById('sub-display').innerText = mode==='ST' ? `ST:${rRemaining}` : (mode==='JITITAN' ? `時短:${rRemaining}` : "通常");
    }

    function addLog(m) { const l = document.getElementById('log'); l.innerHTML = `> ${m}<br>${l.innerHTML}`; }

    let slumpChart, distChart;
    function updateCharts() {
        const ctx1 = document.getElementById('slumpChart').getContext('2d');
        if(slumpChart) slumpChart.destroy();
        slumpChart = new Chart(ctx1, {
            type: 'line',
            data: { labels: balanceHistory.map((_,i)=>i), datasets: [{ label: 'スランプグラフ(円)', data: balanceHistory, borderColor: '#d00000', backgroundColor: 'rgba(208,0,0,0.1)', fill: true, tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        const ctx2 = document.getElementById('distChart').getContext('2d');
        if(distChart) distChart.destroy();
        distChart = new Chart(ctx2, {
            type: 'bar',
            data: { labels: ['-100', '-300', '-500', '-1000', '1000+'], datasets: [{ label: '初当分布', data: distData, backgroundColor: '#0066cc' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
