<div id="machine">
    <div id="stats">
        <div class="stat-box">初当り<br><span id="hits" class="stat-val">0</span></div>
        <div class="stat-box">RUSH回数<br><span id="rush-count" class="stat-val">0</span></div>
        <div class="stat-box">現在回転数<br><span id="current-rot" class="stat-val">0</span></div>
        <div class="stat-box">総回転数<br><span id="total-rot" class="stat-val">0</span></div>
        <div class="stat-box" style="grid-column: span 2;">差玉<br><span id="balance" class="stat-val val-blue">0</span></div>
    </div>

    <div id="sub-display">通常:0</div>
    
    <div id="screen">
        <div id="effect-overlay"></div>
        <div id="d1" class="digit odd">1</div>
        <div id="d2" class="digit odd">1</div>
        <div id="d3" class="digit odd">1</div>
    </div>

    <div id="heso-area">
        <div id="h0" class="heso-ball heso-current"></div>
        <div id="h1" class="heso-ball"></div>
        <div id="h2" class="heso-ball"></div>
        <div id="h3" class="heso-ball"></div>
        <div id="h4" class="heso-ball"></div>
    </div>

    <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
        <button id="btn-slow" class="btn-auto" onclick="toggleAuto('slow')">低速回転</button>
        <button id="btn-fast" class="btn-auto" onclick="toggleAuto('fast')">高速回転</button>
    </div>
    
    <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
        <button id="btn-kokuchi" onclick="toggleOpt('kokuchi')">隠しランプ告知</button>
        <button onclick="openModal()">グラフ表示</button>
        <button onclick="resetData()">リセット</button>
    </div>

    <div id="log-container">
        <div id="log">--- 待機中 ---</div>
    </div>
</div>

<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; align-items:center; justify-content:center; flex-direction:column;">
    <div style="background:#222; width:90%; height:80%; padding:20px; border-radius:10px;">
        <canvas id="slumpChart"></canvas>
        <canvas id="historyChart"></canvas>
    </div>
    <button onclick="closeModal()" style="margin-top:20px; padding:10px 40px;">閉じる</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    #machine { width: 450px; border: 10px solid #444; border-radius: 20px; background: #111; padding: 20px; position: relative; box-shadow: 0 0 50px rgba(138,43,226,0.3); }
    
    /* 演出：振動とフラッシュ */
    .vibrate { animation: vibration 0.05s infinite; }
    @keyframes vibration { 0% { transform: translate(0,0); } 50% { transform: translate(2px,2px); } 100% { transform: translate(-2px,-2px); } }
    .flash-active { animation: screen-flash 0.1s infinite; }
    @keyframes screen-flash { 0% { background: #000; } 50% { background: #fff; } 100% { background: #000; } }
    @keyframes rainbow-border { 0% { border-color: red; } 20% { border-color: yellow; } 40% { border-color: green; } 60% { border-color: cyan; } 80% { border-color: blue; } 100% { border-color: magenta; } }

    /* 図柄表示部：現在の1.5倍サイズ */
    #screen { height: 250px; background: #000; border: 5px solid #222; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 20px; }
    .digit { font-size: 120px; font-weight: bold; margin: 0 10px; color: #fff; text-shadow: 0 0 15px #fff; }
    .gold { color: #ffd700 !important; text-shadow: 0 0 25px #ffd700 !important; }
    .even { color: #4444ff; text-shadow: 0 0 15px #4444ff; }
    .odd { color: #ff4444; text-shadow: 0 0 15px #ff4444; }
    #effect-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; font-size:40px; font-weight:bold; color:white; z-index:10; background:rgba(0,0,0,0.5); pointer-events:none; }

    /* 履歴表示部：現在の1.5倍サイズ */
    #log { height: 350px; font-size: 18px; color: #0f0; overflow-y: auto; background: #000; padding: 10px; border: 2px solid #333; font-family: monospace; line-height: 1.5; }

    /* 保留デザイン（通常：丸、右打ち：バー） */
    #heso-area { display: flex; justify-content: center; margin-bottom: 15px; height: 50px; align-items: center; }
    .heso-ball { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #555; margin: 0 6px; }
    .heso-on { background: #fff; box-shadow: 0 0 10px #fff; }
    .heso-red { background: #f00 !important; box-shadow: 0 0 15px #f00; }
    .heso-green { background: #0f0 !important; }
    .heso-blue { background: #00f !important; }
    .heso-vibe { background: #fff; animation: vibration 0.1s infinite; }
    .heso-rainbow { animation: rainbow-bg 0.5s infinite; }
    @keyframes rainbow-bg { 0%{background:red} 25%{background:yellow} 50%{background:lime} 75%{background:blue} 100%{background:magenta} }

    .right-mode .heso-ball { width: 45px !important; height: 10px !important; border-radius: 2px !important; margin: 5px 0 !important; }

    /* ボタン */
    button { padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; border-radius: 5px; font-size: 14px; }
    .btn-stop { background: #a00 !important; font-weight: bold; }
    .active { background: #070 !important; border-color: #0f0; }
    #sub-display { text-align: center; font-size: 20px; font-weight: bold; color: #ff0; margin-bottom: 5px; }
</style>

    
<script>
    const SPECS = { n: 319.7, s: 99.4, st: 163, jt: 100 };
    let hits=0, rushCount=0, currentRot=0, totalRot=0, totalBall=0, currentRushHits=0;
    let mode='通常', rRem=0, isAuto=false, autoSpeed='slow', isAnim=false;
    let lcdCount=0, optKokuchi=false;
    let slumpData=[0], slumpLabels=["0"], historyData=[], historyLabels=[];
    let reservedStock = [], activeJob = null, originalSpeedSetting = 'slow';
    let sChart, hChart;

    const TRUST_MAP_N = { "白レバ": 0.90, "赤レバ": 0.965, "赤保留": 0.90, "次回予告": 0.65, "レイ背景": 0.85, "金系": 0.50, "カウントダウン": 0.88, "カヲル": 1.0 };
    const TRUST_MAP_S = { "白レバ": 0.95, "赤レバ": 0.99, "赤保留": 0.95, "次回予告": 1.0, "レイ背景": 0.92, "金系": 0.95, "カウントダウン": 0.88, "カヲル": 1.0 };

    function triggerVibeUI(color) {
        const m = document.getElementById('machine');
        m.classList.add('vibrate');
        if (color === "white") { m.style.borderColor = "#fff"; m.style.boxShadow = "0 0 20px #fff"; }
        else if (color === "red") { m.style.borderColor = "#f00"; m.style.boxShadow = "0 0 20px #f00"; }
        else if (color === "rainbow") { m.style.animation = "vibration 0.05s infinite, rainbow-border 0.3s infinite"; }
        setTimeout(() => { m.classList.remove('vibrate'); m.style.borderColor = ""; m.style.boxShadow = ""; m.style.animation = ""; }, 500);
    }

    function preCheck() {
        if (reservedStock.length >= 4) return;
        let isHit = Math.random() < (1 / (mode !== '通常' ? SPECS.s : SPECS.n));
        let holdType = "none", preVibe = "none", hasCountdown = false, isKaworu = false;
        
        if (isHit) {
            if (Math.random() < 0.05) hasCountdown = true;
            if (Math.random() < (mode === '通常' ? 0.02 : 0.05)) isKaworu = true;

            if (mode === '通常') {
                let hRoll = Math.random() * 100;
                if (hRoll < 33) holdType = "red";
                else if (hRoll < 45) { holdType = "vibe"; let vr = Math.random() * 100; preVibe = vr < 50 ? "white" : (vr < 90 ? "red" : "rainbow"); }
                else if (hRoll < 48) holdType = "green";
                else if (hRoll < 50) holdType = "blue";
                if (preVibe === "none" && Math.random() < 0.5) { let vr = Math.random()*100; preVibe = vr < 50 ? "white" : (vr < 85 ? "red" : "rainbow"); }
            } else {
                let hRoll = Math.random() * 100;
                if (hRoll < 25) holdType = "red";
                else if (hRoll < 30) { holdType = "vibe"; preVibe = (Math.random() < 0.7 ? "white" : "red"); }
                else if (hRoll < 39) holdType = "rainbow"; 
            }
        } else {
            if (Math.random() < 0.001) hasCountdown = true; // ガセカウントダウン
            let hRoll = Math.random() * 100;
            if (hRoll < 0.1) holdType = "red";
            else if (hRoll < 1.0) holdType = "green";
        }
        
        reservedStock.push({ isHit: isHit, holdType: holdType, preVibe: preVibe, hasCountdown: hasCountdown, isKaworu: isKaworu });
        if (preVibe !== "none") triggerVibeUI(preVibe);
        if ((holdType === "red" || holdType === "vibe" || isKaworu || hasCountdown) && isAuto && autoSpeed === "fast") { autoSpeed = 'slow'; resetBtns(); }
        updateHesoUI();
    }

    function selectEffect(job) {
        let res = { heavy: false, name: [], trust: 0, vibe: false, vibeColor: job.preVibe, flash: false, text: "", holdType: job.holdType, isSure: false, hasCountdown: job.hasCountdown, isKaworu: job.isKaworu };
        const map = (mode !== '通常') ? TRUST_MAP_S : TRUST_MAP_N;

        if (res.isKaworu) { res.name.push("カヲル"); res.isSure = true; res.text = "カヲル：歌はいいね"; res.flash = true; }
        if (res.holdType === "red") res.name.push("赤保留");
        if (res.holdType === "vibe") res.name.push("ぷるぷる保留");
        if (res.holdType === "rainbow") { res.name.push("虹保留"); res.isSure = true; }
        if (res.hasCountdown) { res.name.push("カウントダウン"); res.heavy = true; }
        if (res.vibeColor !== "none") { res.vibe = true; res.name.push(res.vibeColor === "rainbow" ? "虹レバ" : (res.vibeColor === "red" ? "赤レバ" : "白レバ")); if(res.vibeColor === "rainbow") res.isSure = true; res.heavy = true; }

        if (job.isHit) {
            if (mode === '通常') {
                if (!res.isKaworu) {
                    if (Math.random() < 0.40) { res.name.push("次回予告"); res.text="次回予告"; }
                    if (Math.random() < 0.20) { res.name.push("レイ背景"); res.text="レイ背景"; }
                    if (Math.random() < 0.60) res.name.push("金系");
                }
            } else {
                let eRoll = Math.random() * 100;
                if (eRoll < 30) res.name.push("金系");
                else if (eRoll < 40) { res.name.push("次回予告"); res.text="次回予告"; }
            }
            res.heavy = true;
        }

        res.name = [...new Set(res.name)];
        if (res.isSure) res.trust = 100; 
        else if (res.name.length > 0) {
            let fail = 1; res.name.forEach(n => { let t = map[n] || 0.05; fail *= (1 - t); });
            res.trust = (1 - fail) * 100;
        } else { res.trust = (mode === '通常' ? 0.1 : 1.0); }
        
        res.displayName = res.name.join("+") || (job.isHit ? "無演出" : "弱予告");
        return res;
    }

    async function startProcess() {
        if(!isAuto || isAnim) return;
        
        if(mode !== '通常' && rRem <= 0) {
            let prev = mode;
            addLog(`【${prev}終了】 ${currentRushHits <= 1 ? '1回(' + prev + ')' : currentRushHits + '連'}`);
            mode = '通常'; rushCount = 0; currentRushHits = 0; lcdCount = 0;
            updateUI();
            if (prev === '時短' && originalSpeedSetting === 'fast') { autoSpeed = 'fast'; resetBtns(); }
            else { isAuto = false; resetBtns(); return; }
        }

        while(reservedStock.length < 1) preCheck();
        activeJob = reservedStock.shift();
        updateHesoUI();
        while(reservedStock.length < 4) preCheck();
        let eff = selectEffect(activeJob);
        
        if(optKokuchi && activeJob.isHit) { eff.flash=true; eff.isSure=true; eff.trust=100; eff.displayName="インフラ告知"; }
        
        totalRot++; currentRot++; lcdCount++; 
        if(mode !== '通常') { rRem--; totalBall -= 0.05; }
        else { totalBall -= (250 / 18); }
        
        if (eff.hasCountdown) {
            addLog(`<span style="color:#f44; font-weight:bold;">●3...</span>`); await new Promise(r => setTimeout(r, 400));
            addLog(`<span style="color:#f44; font-weight:bold;">●2...</span>`); await new Promise(r => setTimeout(r, 400));
            addLog(`<span style="color:#f44; font-weight:bold;">●1...</span>`); await new Promise(r => setTimeout(r, 400));
        }

        if(eff.trust >= 50 || activeJob.isHit || eff.hasCountdown) {
            let logMsg = `${mode} ${lcdCount}回転【${eff.displayName}】信頼度:${eff.trust.toFixed(1)}%`;
            if(eff.isKaworu) logMsg = `<span style="color:#f0f; font-weight:bold;">${logMsg}</span>`;
            addLog(logMsg);
            if(eff.vibe) triggerVibeUI(activeJob.preVibe);
            if(eff.flash) document.getElementById('screen').classList.add('flash-active');
            if(eff.text) { const ov = document.getElementById('effect-overlay'); ov.innerText = eff.text; ov.style.display = 'block'; }
        }
        
        let spinTime = (eff.heavy) ? 2500 : (autoSpeed === 'fast' ? 60 : 600);
        let spin = setInterval(() => { 
            let n1 = Math.floor(Math.random()*9)+1, n2 = Math.floor(Math.random()*9)+1, n3 = Math.floor(Math.random()*9)+1;
            if (!activeJob.isHit) while(n1 === n2 && n2 === n3) { n3 = Math.floor(Math.random()*9)+1; }
            if (mode === '通常') { if (n1 === 7) n1 = 8; if (n2 === 7) n2 = 8; if (n3 === 7) n3 = 8; }
            const d1=document.getElementById('d1'), d2=document.getElementById('d2'), d3=document.getElementById('d3');
            d1.innerText=n1; d1.className='digit '+(n1%2===0?'even':'odd');
            d2.innerText=n2; d2.className='digit '+(n2%2===0?'even':'odd');
            d3.innerText=n3; d3.className='digit '+(n3%2===0?'even':'odd');
            if(n1===7) d1.classList.add('gold'); if(n2===7) d2.classList.add('gold'); if(n3===7) d3.classList.add('gold');
        }, 40);
        
        await new Promise(r => setTimeout(r, spinTime));
        clearInterval(spin);
        document.getElementById('screen').classList.remove('flash-active');
        document.getElementById('effect-overlay').style.display = 'none';
        
        if(activeJob.isHit) {
            isAnim = true; hits++;
            if(mode === '通常') { historyData.push(currentRot); historyLabels.push(hits + "回目"); }
            currentRot = 0;
            let rand = Math.random()*100, logDigit, isST = false, bonusText = "";

            if (mode !== '通常') {
                logDigit = (rand < 50) ? 7 : [1,3,5,9][Math.floor(Math.random()*4)];
                isST = true; totalBall += 1400;
            } else {
                if (activeJob.isKaworu || activeJob.preVibe === "rainbow") {
                    logDigit = [1,3,5,7,9][Math.floor(Math.random()*5)]; isST = true; totalBall += (logDigit === 7 ? 1400 : 420);
                } else if (rand < 2) {
                    logDigit = 7; isST = true; totalBall += 1400; bonusText = "[全回転] ";
                } else if (rand < 5) {
                    logDigit = 7; isST = true; totalBall += 1400;
                } else if (rand < 59) {
                    logDigit = [1,3,5,9][Math.floor(Math.random()*4)]; isST = true; totalBall += 420;
                } else {
                    logDigit = [2,4,6,8][Math.floor(Math.random()*4)]; isST = false; totalBall += 420;
                }
            }

            [1,2,3].forEach(i => { const el = document.getElementById('d'+i); el.innerText = logDigit; el.className = 'digit '+(logDigit==7?'gold':(logDigit%2!==0?'odd':'even')); });
            await new Promise(r => setTimeout(r, 1500));
            if(isST) { mode = 'ST'; rRem = SPECS.st; rushCount++; } else { mode = '時短'; rRem = SPECS.jt; }
            addLog(`>> ${mode}突入 ${bonusText}【${logDigit}】 当り!`);
            currentRushHits++;
            updateUI(); await new Promise(r => setTimeout(r, 1500));
            lcdCount = 0; reservedStock = []; activeJob = null;
        }
        isAnim = false;
        updateUI(); resetBtns();
        if(isAuto) setTimeout(startProcess, (autoSpeed === 'fast' ? 5 : 300));
    }
    
    function toggleAuto(s) { if(isAuto && autoSpeed === s) { isAuto = false; originalSpeedSetting = 'slow'; } else { isAuto = true; autoSpeed = s; originalSpeedSetting = s; if(!isAnim) startProcess(); } resetBtns(); }
    function resetBtns() { document.querySelectorAll('.btn-auto').forEach(b => b.classList.remove('btn-stop')); if(isAuto) document.getElementById('btn-' + autoSpeed).classList.add('btn-stop'); }
    function toggleOpt(t) { if(t==='kokuchi') optKokuchi=!optKokuchi; document.getElementById('btn-'+t).classList.toggle('active'); }
    function updateHesoUI() { 
        const isM = (mode !== '通常'); const hA = document.getElementById('heso-area');
        if(isM) hA.classList.add('right-mode'); else hA.classList.remove('right-mode');
        for(let i=0; i<=4; i++) { const el = document.getElementById('h'+i); const s = (i===0) ? activeJob : reservedStock[i-1]; el.className = `heso-ball ${i===0?'heso-current':''}`;
            if(s) { if(s.isKaworu || s.preVibe === 'rainbow' || s.holdType === 'rainbow') el.classList.add('heso-rainbow'); else if(s.holdType !== 'none') el.classList.add('heso-' + s.holdType); else el.classList.add('heso-on'); }
        } 
    }
    function updateUI() { 
        document.getElementById('hits').innerText = hits; document.getElementById('rush-count').innerText = rushCount; 
        document.getElementById('current-rot').innerText = currentRot; document.getElementById('total-rot').innerText = totalRot; 
        document.getElementById('balance').innerText = Math.floor(totalBall).toLocaleString();
        document.getElementById('sub-display').innerText = mode==='通常' ? `通常:${lcdCount}` : `${mode}:${rRem}`; 
        updateHesoUI(); 
    }
    function addLog(m) { const l = document.getElementById('log'); l.innerHTML = `> ${m}<br>${l.innerHTML}`; }
    function openModal() { document.getElementById('modal-overlay').style.display='flex'; /* ChartJS描画処理(省略) */ }
    function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
    function resetData() { location.reload(); }
</script>
</body>
</html>
















































































