<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EVANGELION Sim -2025 Corrected-</title>
    <style>
        /* --- デザイン (CSS) --- */
        @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@800&display=swap');
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { width: 100%; height: 50px; background: #111; border-bottom: 2px solid #8a2be2; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; gap: 8px; }
        .header-btn { background: #333; color: #ccc; border: 1px solid #555; padding: 5px 8px; font-size: 0.7rem; cursor: pointer; border-radius: 4px; }
        .max-hamari-display { background: #000; color: #ff4444; border: 1px solid #ff4444; padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; font-weight: bold; margin-left: auto; }

        .main-content { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .machine { width: 100%; background: #111; border: 3px solid #8a2be2; border-radius: 15px; padding: 12px; box-sizing: border-box; }
        .screen { background: #000; height: 320px; border-radius: 10px; border: 2px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }

        /* 図柄表示部分 1.5倍サイズ */
        .digit-container { display: flex; gap: 8px; }
        .digit { font-size: 11rem; font-weight: 900; font-family: 'Shippori Mincho B1', serif; width: 120px; text-align: center; line-height: 1; } 
        .gold { color: #ffeb3b; text-shadow: 0 0 30px #ffeb3b; }
        .odd { color: #ff4444; text-shadow: 0 0 20px #ff4444; }
        .even { color: #4444ff; text-shadow: 0 0 20px #4444ff; }

        .mode-display { position: absolute; bottom: 35px; right: 15px; color: #8a2be2; font-weight: bold; font-size: 0.9rem; text-align: right; }
        .hidden-lamp { position: absolute; top: 12px; right: 20px; width: 15px; height: 15px; background: #222; border-radius: 50%; border: 1px solid #444; }
        .lamp-active { animation: rainbow-bg 0.3s infinite; box-shadow: 0 0 20px #fff; }
        @keyframes rainbow-bg { 0% { background: #f00; } 20% { background: #ff0; } 40% { background: #0f0; } 60% { background: #0ff; } 80% { background: #00f; } 100% { background: #f0f; } }

        /* 筐体振動 */
        .vibrate { animation: vibration 0.05s infinite; }
        @keyframes vibration { 0% { transform: translate(0,0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0,0); } }
        .vibe-white { border-color: #fff !important; box-shadow: 0 0 20px #fff; }
        .vibe-red { border-color: #f00 !important; box-shadow: 0 0 20px #f00; }
        .vibe-rainbow { border-color: #f0f !important; animation: vibration 0.05s infinite, rainbow-bg 0.5s infinite; }

        /* 保留 */
        .heso-overlay { position: absolute; bottom: 10px; display: flex; gap: 8px; }
        .heso-ball { width: 15px; height: 15px; background: #333; border-radius: 50%; border: 1px solid #555; }
        .heso-blue { background: #00f; } .heso-green { background: #0f0; } .heso-red { background: #f00; } .heso-vibe { background: #fff; animation: vibration 0.1s infinite; } .heso-rainbow { animation: rainbow-bg 0.5s infinite; }

        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 10px; width: 100%; }
        .stat-item { background: #000; border: 1px solid #333; padding: 5px 0; text-align: center; border-radius: 4px; }
        .stat-val { font-size: 1rem; font-weight: bold; color: #fff; display: block; }
        .stat-label { font-size: 0.5rem; color: #888; }

        .control-panel { margin-top: 10px; display: flex; gap: 5px; width: 100%; height: 50px; }
        .btn-auto { flex: 1; background: #8a2be2; color: white; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; }
        .btn-stop { background: #444 !important; }

        /* 履歴表示 1.5倍サイズ */
        .log { width: 100%; max-width: 500px; height: 400px; background: #000; margin-top: 10px; padding: 15px; font-size: 1.3rem; color: #ffffff; overflow-y: auto; border: 1px solid #333; font-family: monospace; box-sizing: border-box; }
        .effect-text { position: absolute; color: white; font-weight: bold; font-size: 2rem; z-index: 5; text-shadow: 0 0 10px #000; background: rgba(0,0,0,0.7); padding: 5px 15px; display: none; }
    </style>
</head>
<body>
    <header>
        <button class="header-btn" onclick="resetData()">リセット</button>
        <div id="max-hamari-box" class="max-hamari-display">最大ハマリ: 0</div>
    </header>
    
    <div class="main-content">
        <div class="machine" id="machine">
            <div id="lamp" class="hidden-lamp"></div>
            <div class="screen" id="screen">
                <div id="effect-overlay" class="effect-text"></div>
                <div class="digit-container">
                    <div id="d1" class="digit odd">1</div>
                    <div id="d2" class="digit odd">2</div>
                    <div id="d3" class="digit odd">3</div>
                </div>
                <div id="sub-display" class="mode-display">通常:0</div>
                <div id="heso-area" class="heso-overlay">
                    <div id="h1" class="heso-ball"></div>
                    <div id="h2" class="heso-ball"></div>
                    <div id="h3" class="heso-ball"></div>
                    <div id="h4" class="heso-ball"></div>
                </div>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-label">大当り</span><span id="hits" class="stat-val">0</span></div>
                <div class="stat-item"><span class="stat-label">連チャン</span><span id="rush-count" class="stat-val">0</span></div>
                <div class="stat-item"><span class="stat-label">現在</span><span id="current-rot" class="stat-val">0</span></div>
                <div class="stat-item"><span class="stat-label">累計</span><span id="total-rot" class="stat-val">0</span></div>
                <div class="stat-item"><span class="stat-label">差玉</span><span id="balance" class="stat-val">0</span></div>
            </div>
            <div class="control-panel">
                <button class="btn-auto" id="btn-slow" onclick="toggleAuto('slow')">低速</button>
                <button class="btn-auto" id="btn-fast" onclick="toggleAuto('fast')">高速</button>
            </div>
        </div>
        <div class="log" id="log">> READY</div>
    </div>

    <script>
        /* --- ロジック (JS) --- */
        let hits = 0, rushCount = 0, currentRot = 0, totalRot = 0, totalBall = 0, maxHamari = 0, lcdCount = 0;
        let mode = '通常', rRem = 0, isAuto = false, autoSpeed = 'slow', isAnim = false;
        let reservedStock = [];

        // 信頼度定義
        const TRUST = { 
            N: { "虹": 1.0, "渚": 1.0, "赤レ": 0.965, "白レ": 0.90, "赤保": 0.90, "レイ": 0.85, "次回": 0.65, "金系": 0.50, "緑保": 0.11, "青保": 0.03, "弱": 0.0113 },
            S: { "虹": 1.0, "渚": 1.0, "次回": 1.0, "赤レ": 0.99, "白レ": 0.95, "赤保": 0.95, "レイ": 0.98, "金系": 0.80, "緑保": 0.20, "青保": 0.05, "点滅": 0.01, "弱": 0.002 }
        };

        function createJob() {
            let res = { isHit: false, name: "", trust: 0, vibe: "", text: "", hold: "" };
            let r = Math.random() * 100;
            let m = (mode === '通常' || mode === '時短') ? 'N' : 'S';

            if (m === 'N') {
                if (r < 0.05) { res.name = "虹"; res.vibe = "rainbow"; res.hold = "rainbow"; }
                else if (r < 0.10) { res.name = "渚"; }
                else if (r < 0.20) { res.name = "赤レ"; res.vibe = "red"; res.hold = "vibe"; }
                else if (r < 0.40) { res.name = "白レ"; res.vibe = "white"; res.hold = "vibe"; }
                else if (r < 0.65) { res.name = "赤保"; res.hold = "red"; }
                else if (r < 0.93) { res.name = "レイ"; res.text = "レイ背景"; }
                else if (r < 1.28) { res.name = "次回"; res.text = "次回予告"; }
                else if (r < 1.67) { res.name = "金系"; }
                else if (r < 5.67) { res.name = "緑保"; res.hold = "green"; }
                else if (r < 13.67) { res.name = "青保"; res.hold = "blue"; }
                else { res.name = "弱"; }
            } else {
                // ST中 (再修正値反映)
                if (r < 0.20) { res.name = "虹"; res.vibe = "rainbow"; res.hold = "rainbow"; }
                else if (r < 0.49) { res.name = "次回"; res.text = "次回予告"; }
                else if (r < 0.69) { res.name = "赤レ"; res.vibe = "red"; res.hold = "vibe"; }
                else if (r < 1.02) { res.name = "白レ"; res.vibe = "white"; res.hold = "vibe"; }
                else if (r < 1.42) { res.name = "赤保"; res.hold = "red"; }
                else if (r < 1.67) { res.name = "レイ"; res.text = "レイ背景"; }
                else if (r < 2.17) { res.name = "金系"; }
                else if (r < 4.67) { res.name = "緑保"; res.hold = "green"; }
                else if (r < 9.67) { res.name = "青保"; res.hold = "blue"; }
                else if (r < 17.67) { res.name = "点滅"; res.hold = "blue"; }
                else { res.name = "弱"; }
            }
            res.trust = TRUST[m][res.name];
            if (Math.random() < res.trust) res.isHit = true;
            return res;
        }

        async function startProcess() {
            if (!isAuto || isAnim) return;
            if (mode !== '通常' && rRem <= 0) {
                addLog(`【${mode}終了】 ${rushCount}連`);
                mode = '通常'; rushCount = 0; lcdCount = 0;
                updateUI(); isAuto = false; updateBtns(); return;
            }

            isAnim = true;
            while (reservedStock.length < 4) reservedStock.push(createJob());
            let job = reservedStock.shift();
            
            totalRot++; currentRot++; lcdCount++;
            if (mode === '通常') totalBall -= 13.8; else { rRem--; totalBall -= 0.1; }

            // 信頼度50%以上の演出だけログに
            if (job.trust >= 0.5 || job.isHit) {
                addLog(`${mode} ${lcdCount}回:【${job.name}】信頼度:${(job.trust*100).toFixed(1)}%`);
            }

            if (job.vibe) document.getElementById('machine').className = 'machine vibrate vibe-' + job.vibe;
            if (job.text) { let o = document.getElementById('effect-overlay'); o.innerText = job.text; o.style.display = 'block'; }
            
            updateUI();
            await new Promise(r => setTimeout(r, autoSpeed === 'fast' ? 100 : 500));
            
            // 図柄決定
            let hitDig = 0;
            if (job.isHit) {
                let r = Math.random() * 100;
                if (mode === '通常') {
                    if (r < 5) hitDig = 7;
                    else if (r < 41) hitDig = [2,4,6,8][Math.floor(Math.random()*4)];
                    else hitDig = [1,3,5,9][Math.floor(Math.random()*4)];
                } else hitDig = Math.random() < 0.5 ? 3 : 7;
                
                [1,2,3].forEach(i => {
                    let d = document.getElementById('d'+i); d.innerText = hitDig;
                    d.className = (hitDig%2!==0 || hitDig===7) ? 'digit odd' : 'digit even';
                    if (hitDig===7) d.classList.add('gold');
                });

                hits++;
                let isST = (hitDig%2!==0);
                if (!isST && Math.random() < 0.20) {
                    await new Promise(r => setTimeout(r, 500));
                    hitDig = [1,3,5,9][Math.floor(Math.random()*4)];
                    [1,2,3].forEach(i => { document.getElementById('d'+i).innerText = hitDig; document.getElementById('d'+i).className = 'digit odd'; });
                    addLog(">> 昇格！！"); isST = true;
                }
                
                totalBall += (isST && hitDig===7) || mode !== '通常' ? 1400 : 420;
                if (mode === '通常') { if(currentRot > maxHamari) maxHamari = currentRot; }
                mode = isST ? 'ST' : '時短';
                rRem = isST ? 163 : 100;
                rushCount++; currentRot = 0; lcdCount = 0;
                await new Promise(r => setTimeout(r, 1000));
            } else {
                let d1 = Math.floor(Math.random()*9)+1;
                let d3 = (d1+1)%9+1;
                [1,2,3].forEach(i => { document.getElementById('d'+i).innerText = i===2?Math.floor(Math.random()*9)+1:(i===1?d1:d3); document.getElementById('d'+i).className = 'digit even'; });
            }

            document.getElementById('machine').className = 'machine';
            document.getElementById('effect-overlay').style.display = 'none';
            isAnim = false;
            updateUI();
            if (isAuto) setTimeout(startProcess, autoSpeed === 'fast' ? 50 : 200);
        }

        function toggleAuto(s) { if(isAuto && autoSpeed === s) isAuto = false; else { isAuto = true; autoSpeed = s; } updateBtns(); if(isAuto) startProcess(); }
        function updateBtns() { document.getElementById('btn-slow').className = (isAuto && autoSpeed==='slow') ? 'btn-auto btn-stop' : 'btn-auto'; document.getElementById('btn-fast').className = (isAuto && autoSpeed==='fast') ? 'btn-auto btn-stop' : 'btn-auto'; }
        function updateUI() {
            document.getElementById('hits').innerText = hits;
            document.getElementById('rush-count').innerText = rushCount;
            document.getElementById('current-rot').innerText = currentRot;
            document.getElementById('total-rot').innerText = totalRot;
            document.getElementById('balance').innerText = Math.floor(totalBall);
            document.getElementById('sub-display').innerText = `${mode}:${mode==='通常'?lcdCount:rRem}`;
            document.getElementById('max-hamari-box').innerText = `最大ハマリ: ${maxHamari}`;
            // 保留
            for(let i=1; i<=4; i++) {
                let b = document.getElementById('h'+i);
                b.className = 'heso-ball';
                if(reservedStock[i-1] && reservedStock[i-1].hold) b.classList.add('heso-' + reservedStock[i-1].hold);
                else if(reservedStock[i-1]) b.classList.add('heso-blue');
            }
        }
        function addLog(m) { let l = document.getElementById('log'); l.innerHTML = `> ${m}<br>${l.innerHTML}`; }
        function resetData() { if(confirm('リセットしますか？')) location.reload(); }
    </script>
</body>
</html>
