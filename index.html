<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVANGELION Sim -15 Special-</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@800&display=swap');
        body { background: #000; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        /* レバブル演出 */
        @keyframes viberation {
            0% { transform: translate(0,0); }
            10% { transform: translate(-3px, 3px); }
            20% { transform: translate(3px, -3px); }
            100% { transform: translate(0,0); }
        }
        .vibrate { animation: viberation 0.08s infinite; }

        /* インパクトフラッシュ演出 */
        @keyframes flash {
            0% { background: #000; }
            50% { background: #fff; }
            100% { background: #000; }
        }
        .flash-active { animation: flash 0.05s 15; }

        .machine { width: 100%; max-width: 400px; margin: 20px auto; background: #111; border: 3px solid #d00000; border-radius: 20px; padding: 20px; position: relative; box-shadow: 0 0 30px #d00000; }
        
        .screen { background: #000; height: 160px; border-radius: 10px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin-bottom: 15px; }
        .digit { font-size: 4rem; font-weight: 900; font-family: 'Shippori Mincho B1', serif; width: 65px; text-align: center; z-index: 10; }
        .gold { color: #ffeb3b; text-shadow: 0 0 20px #ffeb3b; } .odd { color: #ff4444; } .even { color: #4444ff; }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 5px; }
        .stat-item { background: #000; border: 1px solid #333; padding: 6px; text-align: center; border-radius: 5px; }
        .stat-label { font-size: 0.6rem; color: #888; display: block; }
        .stat-val { font-size: 0.9rem; font-weight: bold; color: #d00000; font-family: monospace; }

        .control-layout { display: flex; gap: 8px; margin-top: 10px; }
        .btn-auto { flex: 1; background: #d00000; color: white; border: 2px solid #ff4444; padding: 15px; font-weight: bold; border-radius: 10px; cursor: pointer; font-size: 1rem; }
        .active-btn { background: #444 !important; border-color: #666 !important; }
        
        .full-auto-btn { width: 50px; background: #222; color: #888; border: 1px solid #444; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .full-auto-btn.on { background: #d00000; color: white; border-color: #ff4444; box-shadow: 0 0 10px #d00000; }

        .log { height: 120px; background: #000; margin-top: 15px; padding: 12px; font-size: 0.75rem; color: #ff4444; overflow-y: auto; border: 1px solid #333; font-family: 'Courier New', Courier, monospace; line-height: 1.4; }
    </style>
</head>
<body id="body">

<div class="machine" id="machine">
    <div class="screen" id="screen">
        <div id="d1" class="digit">1</div><div id="d2" class="digit">2</div><div id="d3" class="digit">3</div>
        <div id="sub-mode" style="position:absolute; bottom:8px; right:12px; color:#d00000; font-weight:bold; font-size:0.7rem;">READY</div>
    </div>

    <div class="stat-grid">
        <div class="stat-item"><span class="stat-label">大当り</span><span id="hits" class="stat-val">0</span></div>
        <div class="stat-item"><span class="stat-label">連チャン</span><span id="rush-count" class="stat-val">0</span></div>
        <div class="stat-item"><span class="stat-label">現在回転</span><span id="current-rot" class="stat-val">0</span></div>
        <div class="stat-item"><span class="stat-label">収支(円)</span><span id="balance" class="stat-val">0</span></div>
    </div>

    <div class="control-layout">
        <button class="full-auto-btn" id="full-auto" onclick="toggleFullAuto()">全</button>
        <button class="btn-auto" id="btn-fast" onclick="toggleAuto()">高速オート 開始/停止</button>
    </div>
    <div class="log" id="log">> エヴァ15：システム正常<br></div>
</div>

<script>
    let hits=0, rushCount=0, currentCount=0, totalBall=0;
    let mode='通常', rRemaining=0, isAuto=false, isFullAuto=false, isAnimating=false;
    let timer = null;

    function toggleFullAuto() {
        isFullAuto = !isFullAuto;
        document.getElementById('full-auto').classList.toggle('on', isFullAuto);
    }

    function toggleAuto() {
        isAuto = !isAuto;
        document.getElementById('btn-fast').classList.toggle('active-btn', isAuto);
        if(isAuto) startProcess();
    }

    async function startProcess() {
        if(!isAuto || isAnimating) return;
        
        if(mode==='通常') totalBall -= 12.5;
        currentCount++;
        
        let prob = (mode==='ST' ? 99.4 : 319.7);
        let isHit = Math.random() < (1 / prob);
        
        // 激アツ演出抽選（実機15風）
        let hasVibe = isHit && Math.random() < 0.75; 
        let hasFlash = isHit && Math.random() < 0.25;

        if (isHit) {
            isAnimating = true;
            if (hasVibe) {
                document.getElementById('machine').classList.add('vibrate');
                addLog("!! レバブル発生 !!");
            }
            if (hasFlash) {
                document.getElementById('screen').classList.add('flash-active');
                addLog("⚡ インパクトフラッシュ ⚡");
            }
            
            await new Promise(r => setTimeout(r, isFullAuto ? 50 : 1500));
            
            document.getElementById('machine').classList.remove('vibrate');
            document.getElementById('screen').classList.remove('flash-active');

            let isSt = (mode !== '通常') || (Math.random() < 0.59);
            let digit = isSt ? [1,3,5,7,9][Math.floor(Math.random()*5)] : [2,4,6,8][Math.floor(Math.random()*4)];
            
            setDigit(digit);
            if(isSt) {
                mode='ST'; rRemaining=163; rushCount++;
                totalBall += 1400;
                addLog(`【${digit}】大当り! RUSH突入 (${currentCount}回転)`);
            } else {
                mode='時短'; rRemaining=100; rushCount=0;
                totalBall += 400;
                addLog(`【${digit}】大当り! 時短100回 (${currentCount}回転)`);
            }
            currentCount=0;
            isAnimating = false;
        } else {
            // ハズレ変動
            if(mode!=='通常') {
                rRemaining--;
                if(rRemaining<=0) { 
                    addLog(`${mode}終了`); 
                    mode='通常'; rushCount=0; 
                    if(!isFullAuto) isAuto=false; 
                }
            }
        }

        updateUI();
        if(isAuto) timer = setTimeout(startProcess, isFullAuto ? 1 : 50);
    }

    function setDigit(d) {
        [1,2,3].forEach(i => {
            const el = document.getElementById('d'+i);
            el.innerText = d;
            el.className = 'digit ' + (d==7?'gold':(d%2!=0?'odd':'even'));
        });
    }

    function updateUI() {
        document.getElementById('hits').innerText = hits;
        document.getElementById('current-rot').innerText = currentCount;
        document.getElementById('rush-count').innerText = rushCount;
        const bal = Math.floor(totalBall*4);
        document.getElementById('balance').innerText = bal.toLocaleString();
        document.getElementById('sub-mode').innerText = mode==='通常' ? "通常" : `${mode}:${rRemaining}`;
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `> ${m}<br>${l.innerHTML}`;
        l.scrollTop = 0;
    }
</script>
</body>
</html>
